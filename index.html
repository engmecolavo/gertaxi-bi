<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI | Sistema de Gestão Gertáxi</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* --- TEMA DARK INDUSTRIAL (Premium) --- */
        :root {
            --bg-body: #121212; --bg-panel: #1e1e1e; --bg-header: #000000;
            --brand: #FFD700; --text-main: #E0E0E0; --text-muted: #A0A0A0; --border: #333;
            --green: #2ecc71; --red: #e74c3c; --blue: #3498db; --orange: #e67e22; --purple: #9b59b6;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow-x: hidden; padding-bottom: 40px; }

        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* HEADER */
        header { 
            background: var(--bg-header); border-bottom: 2px solid var(--brand); 
            min-height: 70px; display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 100; position: relative; 
            flex-wrap: wrap; gap: 10px;
        }
        .logo-area { display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 800; color: var(--text-main); letter-spacing: 1px; white-space: nowrap; }
        
        /* NAV PILLS */
        .nav-pills { display: flex; gap: 5px; background: #222; padding: 4px; border-radius: 6px; overflow-x: auto; }
        .nav-item { 
            padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 13px; font-weight: 600; 
            color: #888; transition: 0.2s; display: flex; align-items: center; gap: 5px; 
            border: 1px solid transparent; white-space: nowrap; user-select: none; text-transform: uppercase;
        }
        .nav-item.active { background: var(--brand); color: #000; }
        .nav-item:hover:not(.active) { color: var(--brand); border-color: #444; }

        /* FILTROS GERAIS */
        .filter-bar { display: flex; align-items: center; gap: 10px; flex-grow: 1; justify-content: flex-end; position: relative; }
        
        /* Dropdown Customizado */
        .custom-dropdown { position: relative; width: 220px; font-size: 13px; font-weight: 500; }
        .dropdown-btn {
            background: #333; border: 1px solid #555; color: #fff; 
            padding: 8px 12px; border-radius: 4px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .dropdown-content {
            display: none; position: absolute; top: 100%; left: 0; width: 100%;
            background: #252525; border: 1px solid #444; border-radius: 4px;
            max-height: 300px; overflow-y: auto; z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); margin-top: 5px;
        }
        .dropdown-content.show { display: block; }
        .dropdown-item {
            padding: 8px 10px; border-bottom: 1px solid #333; 
            display: flex; align-items: center; gap: 8px; cursor: pointer; color: #ccc;
        }
        .dropdown-item:hover { background: #333; color: #fff; }
        .dropdown-item input[type="checkbox"] { transform: scale(1.2); cursor: pointer; accent-color: var(--brand); }

        /* KPI CARDS */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--bg-panel); padding: 15px; border-radius: 6px; border-left: 4px solid var(--brand); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .card-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .card-value { font-size: 24px; font-weight: 700; margin-top: 5px; word-break: break-all; }
        .card-sub { font-size: 10px; opacity: 0.7; margin-top: 2px; }

        /* LAYOUT GRÁFICOS */
        .section-title { font-size: 15px; font-weight: 700; color: var(--brand); margin: 30px 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        .charts-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; align-items: start; }
        .split-grid { display: grid; grid-template-columns: 3fr 7fr; gap: 20px; margin-bottom: 20px; align-items: start; }
        .full-width { grid-column: span 2; } 
        
        .chart-panel { background: var(--bg-panel); border-radius: 6px; padding: 15px; display: flex; flex-direction: column; position: relative; width: 100%; }
        .chart-panel.normal-h { min-height: 400px; }
        .chart-panel.compact { min-height: 320px; } 

        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: 600; color: var(--brand); font-size: 13px; }
        
        .table-container { height: 100%; overflow-y: auto; max-height: 340px; }
        .chart-scroll-wrapper { flex: 1; overflow-y: auto; padding-right: 5px; max-height: 280px; }
        .evol-chart-container { flex: 1; position: relative; min-height: 280px; } 
        
        /* TABELAS */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; background: #252525; color: #aaa; padding: 8px; position: sticky; top: 0; z-index: 2; border-bottom: 2px solid #444; }
        td { border-bottom: 1px solid #333; padding: 8px; vertical-align: middle; }
        tr.clickable-row:hover { background-color: #333; cursor: pointer; transition: 0.2s; }
        tr.selected-row { background-color: rgba(255, 215, 0, 0.15); border-left: 3px solid var(--brand); }
        
        .badge { padding: 3px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; display: inline-block;}
        .bg-corr { background: rgba(231, 76, 60, 0.15); color: var(--red); border: 1px solid rgba(231, 76, 60, 0.3); }
        .bg-prev { background: rgba(52, 152, 219, 0.15); color: var(--blue); border: 1px solid rgba(52, 152, 219, 0.3); }
        
        /* Controles Internos */
        .sub-header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; width: auto; }
        .sub-header-controls select { background:#333; color:#fff; border:1px solid #555; padding:6px; border-radius:4px; font-size:11px; }
        .btn-clear { background: #333; color: #fff; border: 1px solid #555; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 10px; text-transform: uppercase; transition: all 0.2s; }
        .btn-clear:hover { background: var(--brand); color: #000; border-color: var(--brand); }

        /* DASHBOARD VIEW */
        .dashboard-view { display: none; padding: 20px; animation: fadein 0.4s; }
        .dashboard-view.visible { display: block; }
        @keyframes fadein { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 900px) {
            header { justify-content: center; padding-bottom: 15px; }
            .logo-area { width: 100%; justify-content: center; margin-bottom: 5px; }
            .nav-pills { order: 2; width: 100%; justify-content: space-between; margin-bottom: 5px; overflow-x: hidden; }
            .nav-item { flex: 1; justify-content: center; padding: 8px 2px; font-size: 11px; text-align: center; }
            .filter-bar { order: 3; width: 100%; justify-content: center; }
            .custom-dropdown { width: 100%; max-width: 300px; }
            .kpi-row { grid-template-columns: 1fr 1fr; gap: 10px; }
            .charts-row, .split-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .chart-panel.normal-h { min-height: 300px; }
            .dashboard-view { padding: 10px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <span class="material-icons" style="color:var(--brand); font-size: 28px;">directions_bus</span>
        <span>GERTÁXI BI</span>
    </div>
    
    <div class="nav-pills">
        <div class="nav-item active" onclick="setMode('operacional')">
            <span class="material-icons" style="font-size:16px">build</span> PAINEL OPERACIONAL
        </div>
        <div class="nav-item" onclick="setMode('gerencial')">
            <span class="material-icons" style="font-size:16px">insights</span> PAINEL GERENCIAL
        </div>
        <div class="nav-item" onclick="setMode('tecnica')">
            <span class="material-icons" style="font-size:16px">trending_up</span> PERFORMANCE TÉCNICA
        </div>
    </div>

    <div class="filter-bar">
        <div class="custom-dropdown" id="main-filter-container">
            <div class="dropdown-btn" onclick="toggleFilterMenu()">
                <span id="filter-text">Carregando...</span>
                <span class="material-icons" style="font-size:18px">arrow_drop_down</span>
            </div>
            <div class="dropdown-content" id="filter-options"></div>
        </div>
        <div id="loading" style="font-size:10px; color:#666; margin-left:5px">
            <span class="material-icons" style="font-size:12px; animation:spin 1s infinite linear">sync</span>
        </div>
    </div>
</header>

<div id="view-operacional" class="dashboard-view visible">
    <div class="kpi-row">
        <div class="card" style="border-color: var(--red)">
            <div class="card-label">Veículos Parados</div>
            <div class="card-value" id="op-parados">0</div>
            <div class="card-sub">Oficina Atual</div>
        </div>
        <div class="card" style="border-color: var(--orange)">
            <div class="card-label">Tempo Médio</div>
            <div class="card-value" id="op-tma">0d</div>
            <div class="card-sub">Dias corridos</div>
        </div>
        <div class="card" style="border-color: var(--blue)">
            <div class="card-label">Ordens Abertas</div>
            <div class="card-value" id="op-ordens">0</div>
            <div class="card-sub">Fila</div>
        </div>
        <div class="card" style="border-color: var(--brand)">
            <div class="card-label">HH Realizado</div>
            <div class="card-value" id="op-hh">0h</div>
            <div class="card-sub">Em aberto</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-panel normal-h">
            <div class="panel-header">Distribuição de HH</div>
            <div style="flex:1; position: relative;"><canvas id="chartOpType"></canvas></div>
        </div>
        <div class="chart-panel normal-h">
            <div class="panel-header">Fila de Ordens</div>
            <div class="table-container">
                <table id="tableOp">
                    <thead><tr><th>O.S.</th><th>Frota</th><th>Tipo</th><th>Modo</th><th>Abertura</th><th>HH</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="chart-panel full-width normal-h">
            <div class="panel-header">
                <span><span class="material-icons" style="font-size:14px; vertical-align:middle; color:var(--green)">engineering</span> Técnicos em Atividade <span id="op-today-date" style="font-weight:600; font-size:11px; color:var(--text-muted); margin-left:8px; text-transform: uppercase;"></span></span>
            </div>
            <div class="table-container">
                <table id="tableMO">
                    <thead><tr><th>O.S.</th><th>Técnico</th><th>Frota</th><th>Tipo</th><th>Natureza</th><th>Serviço</th><th>Início</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="view-gerencial" class="dashboard-view">
    <div class="kpi-row">
        <div class="card">
            <div class="card-label">Ativos</div>
            <div class="card-value" id="mgmt-ativos">0</div>
        </div>
        <div class="card" style="border-color: var(--green)">
            <div class="card-label">Disponibilidade</div>
            <div class="card-value" id="mgmt-disp">0%</div>
            <div class="card-sub">Estimada</div>
        </div>
        <div class="card" style="border-color: var(--orange)">
            <div class="card-label">MTTR Global</div>
            <div class="card-value" id="mgmt-mttr-kpi">0h</div>
            <div class="card-sub">Horas/Falha</div>
        </div>
        <div class="card" style="border-color: var(--brand)">
            <div class="card-label">MKBF</div>
            <div class="card-value" id="mgmt-mkbf">0</div>
            <div class="card-sub">Km/Falha</div>
        </div>
    </div>

    <div class="section-title">
        <span>Análise de Falhas</span>
        <div class="sub-header-controls">
            <select id="central-year" onchange="updateCentralCharts()"></select>
            <select id="central-month" onchange="updateCentralCharts()"></select>
            <button class="btn-clear" onclick="resetCentralSelection()">Limpar</button>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-panel normal-h">
            <div class="panel-header">Natureza dos Serviços</div>
            <div style="flex:1; position: relative;"><canvas id="chartMgmtNatureza"></canvas></div>
        </div>
        <div class="chart-panel normal-h">
            <div class="panel-header">Pareto: Falhas <span id="pareto-filter-label" style="font-size:9px; color:#666; margin-left:5px">(Todas)</span></div>
            <div style="flex:1; position: relative;"><canvas id="chartMgmtPareto"></canvas></div>
        </div>
    </div>

    <div class="section-title">
        <span>Confiabilidade (MKBF)</span>
        <div class="sub-header-controls">
            <select id="mkbf-year" onchange="renderMKBFPanels()"></select>
            <button class="btn-clear" onclick="resetMKBFSelection()">Limpar</button>
        </div>
    </div>

    <div class="split-grid">
        <div class="chart-panel compact">
            <div class="panel-header">Ranking MKBF (Km)</div>
            <div class="chart-scroll-wrapper">
                <div id="mkbf-veic-inner-container" style="position: relative;">
                    <canvas id="chartMgmtMKBFVeic"></canvas>
                </div>
            </div>
        </div>
        <div class="chart-panel compact">
            <div class="panel-header"><span id="lbl-mkbf-evolucao">Evolução</span></div>
            <div class="evol-chart-container"><canvas id="chartMgmtMKBF"></canvas></div>
        </div>
    </div>

    <div class="section-title">
        <span>Manutenibilidade (MTTR)</span>
        <div class="sub-header-controls">
            <select id="mttr-year" onchange="renderMTTRPanels()"></select>
            <button class="btn-clear" onclick="resetMTTRSelection()">Limpar</button>
        </div>
    </div>

    <div class="split-grid">
        <div class="chart-panel compact">
            <div class="panel-header">Ranking MTTR (Horas)</div>
            <div class="chart-scroll-wrapper">
                <div id="mttr-nat-inner-container" style="position: relative;">
                    <canvas id="chartMgmtMTTRRanking"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-panel compact">
            <div class="panel-header"><span id="lbl-mttr-evolucao">Evolução</span></div>
            <div class="evol-chart-container"><canvas id="chartMgmtMTTREvol"></canvas></div>
        </div>
    </div>
</div>

<div id="view-tecnica" class="dashboard-view">
    <div class="section-title" style="margin-top:0">
        <span>Análise de Produtividade Mensal</span>
    </div>

    <div class="kpi-row">
        <div class="card" style="border-color: var(--brand)">
            <div class="card-label">Total HH Produzido</div>
            <div class="card-value" id="tech-total-hh">0h</div>
            <div class="card-sub"><span id="lbl-kpi-filter">Equipe Global</span></div>
        </div>
        <div class="card" style="border-color: var(--blue)">
            <div class="card-label">Ordens Entregues</div>
            <div class="card-value" id="tech-total-ordens">0</div>
            <div class="card-sub">Manutenções</div>
        </div>
        <div class="card" style="border-color: var(--green)">
            <div class="card-label">Produtividade Média</div>
            <div class="card-value" id="tech-avg-prod">0</div>
            <div class="card-sub">HH / Ordem</div>
        </div>
        <div class="card">
            <div class="card-label">Técnicos Ativos</div>
            <div class="card-value" id="tech-count">0</div>
            <div class="card-sub">Com apropriação</div>
        </div>
    </div>

    <div class="split-grid">
        <div class="chart-panel normal-h">
            <div class="panel-header">Dispersão: Volume (Ordens) x Esforço (HH)</div>
            <div style="flex:1; position: relative;"><canvas id="chartTechScatter"></canvas></div>
        </div>
        
        <div class="chart-panel normal-h">
            <div class="panel-header">
                <span id="tech-evol-name" style="color:var(--text-main)">Evolução da Equipe</span>
            </div>
            <div style="flex:1; position: relative;"><canvas id="chartTechEvol"></canvas></div>
        </div>
    </div>

    <div class="chart-panel normal-h">
        <div class="panel-header">
            <span>Ranking de Produtividade</span>
            <div class="sub-header-controls">
                <select id="tech-year" onchange="processTechnical()"></select>
                <select id="tech-month" onchange="processTechnical()"></select>
                <button class="btn-clear" onclick="resetTechnicalView()">Limpar</button>
            </div>
        </div>
        <div class="table-container">
            <table id="tableTechRanking">
                <thead><tr><th>Pos</th><th>Técnico</th><th>Função</th><th>Qtd Ordens</th><th>HH Total</th><th>Média HH/OS</th><th>% Ocupação (Est)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const FILES = {
        frota: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=752179198&single=true&output=csv',
        ordem: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=676143752&single=true&output=csv',
        req:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=1880712397&single=true&output=csv',
        serv:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=670071232&single=true&output=csv',
        mo:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=267479044&single=true&output=csv',
        tec:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=361502971&single=true&output=csv'
    };

    const STATE = { 
        mode: 'operacional', 
        data: {}, 
        filters: { contracts: new Set(), selectedTech: null, naturezaFocus: null, mkbfVehicle: null, mttrNatureza: null },
        processed: { centralData: [], mkbfData: {}, mttrData: {} }
    };
    let charts = {};

    window.onload = async () => { 
        Chart.register(ChartDataLabels);
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('op-today-date').innerText = new Date().toLocaleDateString('pt-BR', dateOptions).toUpperCase();
        
        await loadFiles(); 
        
        document.addEventListener('click', (e) => {
            const container = document.getElementById('main-filter-container');
            if (!container.contains(e.target)) document.getElementById('filter-options').classList.remove('show');
        });

        initFilterOptions(); 
        runDashboardLogic(); 
    };

    async function loadFiles() {
        try {
            const promises = Object.entries(FILES).map(([key, url]) => fetch(url).then(r => r.text()).then(txt => ({key, txt})));
            const results = await Promise.all(promises);
            results.forEach(({key, txt}) => {
                const sep = txt.split('\n')[0].includes(';') ? ';' : ',';
                STATE.data[key] = Papa.parse(txt, { header: true, delimiter: sep, skipEmptyLines: true, transformHeader: h=>h.trim() }).data;
            });
            document.getElementById('loading').innerText = 'ON';
        } catch (e) { console.error(e); alert("Erro ao carregar dados."); }
    }

    function setMode(mode) {
        STATE.mode = mode;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="setMode('${mode}')"]`).classList.add('active');
        document.querySelectorAll('.dashboard-view').forEach(el => el.classList.remove('visible'));
        document.getElementById(`view-${mode}`).classList.add('visible');
        
        // Resetar filtro principal ao trocar de aba para evitar conflitos
        STATE.filters.selection = new Set(['Todos']);
        runDashboardLogic();
    }
    const norm = (str) => (str || '').toString().trim().toUpperCase();

    function toggleFilterMenu() { document.getElementById('filter-options').classList.toggle('show'); }

    function initFilterOptions() {
        const container = document.getElementById('filter-options');
        container.innerHTML = '';
        if (!STATE.data.frota) return;
        const lotes = [...new Set(STATE.data.frota.map(f => f['LOTE']).filter(l => l && l.trim() !== '' && l !== 'Desmobilizado'))].sort();
        addCheckboxOption(container, 'Todos', 'Todos os Contratos', true);
        lotes.forEach(l => addCheckboxOption(container, l, l, false));
        updateFilterButtonLabel();
    }

    function addCheckboxOption(container, value, label, isChecked) {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.onclick = (e) => { if(e.target.tagName !== 'INPUT') { const chk = item.querySelector('input'); chk.checked = !chk.checked; handleCheckboxChange(chk); } };
        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = value; checkbox.checked = isChecked;
        if(isChecked) STATE.filters.contracts.add(value);
        checkbox.onchange = () => handleCheckboxChange(checkbox);
        const text = document.createElement('span'); text.innerText = label;
        item.appendChild(checkbox); item.appendChild(text); container.appendChild(item);
    }

    function handleCheckboxChange(changedChk) {
        const val = changedChk.value;
        const allChk = document.querySelectorAll('#filter-options input[type="checkbox"]');
        if (val === 'Todos') {
            if(changedChk.checked) {
                allChk.forEach(c => { if(c.value !== 'Todos') c.checked = false; });
                STATE.filters.contracts.clear(); STATE.filters.contracts.add('Todos');
            } else { if(STATE.filters.contracts.size === 1) changedChk.checked = true; }
        } else {
            if(changedChk.checked) {
                const chkTodos = document.querySelector('input[value="Todos"]');
                if(chkTodos && chkTodos.checked) { chkTodos.checked = false; STATE.filters.contracts.delete('Todos'); }
                STATE.filters.contracts.add(val);
            } else {
                STATE.filters.contracts.delete(val);
                if(STATE.filters.contracts.size === 0) {
                    const chkTodos = document.querySelector('input[value="Todos"]');
                    if(chkTodos) { chkTodos.checked = true; STATE.filters.contracts.add('Todos'); }
                }
            }
        }
        updateFilterButtonLabel(); runDashboardLogic();
    }

    function updateFilterButtonLabel() {
        const lbl = document.getElementById('filter-text');
        if(STATE.filters.contracts.has('Todos')) lbl.innerText = 'Todos os Contratos';
        else { const count = STATE.filters.contracts.size; lbl.innerText = count === 1 ? [...STATE.filters.contracts][0] : `${count} Contratos`; }
    }

    function runDashboardLogic() { 
        if (STATE.mode === 'operacional') processOperational();
        else if (STATE.mode === 'gerencial') processManagerial();
        else if (STATE.mode === 'tecnica') initTechnicalView();
    }

    // =========================================================================
    // LÓGICA OPERACIONAL
    // =========================================================================
    function processOperational() {
        const frotaLoteMap = new Map(); STATE.data.frota.forEach(f => frotaLoteMap.set(f['FROTA'], f['LOTE']));
        const checkContract = (frota) => {
            if(STATE.filters.contracts.has('Todos')) return true;
            const lote = frotaLoteMap.get(frota); return lote && STATE.filters.contracts.has(lote);
        };

        const reqsAbertas = STATE.data.req.filter(r => (norm(r['Status da requisição']) !== 'ENCERRADA' && norm(r['Status da requisição']) !== 'CANCELADA') && checkContract(r['Frota']));
        const frotaParada = new Set(reqsAbertas.map(r => r['Frota'])).size;
        const ordensAbertas = STATE.data.ordem.filter(o => norm(o['Status da ordem']) === 'ABERTA' && checkContract(o['Frota']));
        const servMap = new Map(); STATE.data.serv.forEach(s => servMap.set(s['ID'], s));
        const moAtivos = STATE.data.mo.filter(m => { const hIni = m['Hora inicial']; const hFim = m['Hora final']; return (hIni && hIni.trim() !== '') && (!hFim || hFim.trim() === ''); });

        const moTabelaDados = [];
        moAtivos.forEach(m => {
            let serv = null, ordem = null;
            if(m['ID_SERV']) { serv = servMap.get(m['ID_SERV']); if(serv) ordem = STATE.data.ordem.find(o => o['ID'] === serv['ID_Ordem']); }
            else if(m['ID_Ordem']) { ordem = STATE.data.ordem.find(o => o['ID'] === m['ID_Ordem']); }
            
            const frota = ordem ? ordem['Frota'] : (serv ? serv['Frota'] : null);
            if (!checkContract(frota)) return;

            moTabelaDados.push({ 
                numOrdem: ordem ? ordem['Nº Ordem'] : 'N/A', 
                tecnico: m['Técnico']||'ND', 
                frota: frota || 'N/A', 
                tipoManut: ordem ? ordem['Tipo de manutenção'] : 'N/A', 
                natureza: serv ? (serv['Natureza do serviço'] || '-') : '-',
                tipoServ: serv ? (serv['Tipo de serviço'] || serv['Serviço']) : (m['Serviço'] || 'Mão de Obra Geral'), 
                inicio: m['Hora inicial'] 
            });
        });

        const tbodyMO = document.querySelector('#tableMO tbody'); tbodyMO.innerHTML = '';
        if(moTabelaDados.length===0) tbodyMO.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#666;padding:20px">Nenhum técnico em atividade no momento.</td></tr>';
        else moTabelaDados.forEach(d => tbodyMO.innerHTML += `<tr><td style="font-weight:bold;color:var(--brand)">${d.numOrdem}</td><td>${d.tecnico}</td><td style="color:#aaa">${d.frota}</td><td><span class="badge ${norm(d.tipoManut).includes('CORRETIVA')?'bg-corr':'bg-prev'}">${d.tipoManut}</span></td><td>${d.natureza}</td><td>${d.tipoServ}</td><td>${d.inicio}</td></tr>`);

        let somaDias=0; const hoje=new Date(); ordensAbertas.forEach(o=>{const d=parseDate(o['Data da abertura']); if(d) somaDias+=(hoje-d)/(864e5);});
        const tma = ordensAbertas.length>0?(somaDias/ordensAbertas.length).toFixed(1):0;
        
        let totalHH=0, hhCorr=0, hhPrev=0; 
        const idsAbertos = new Set(ordensAbertas.map(o=>o['ID']));
        const mapTipo = new Map(); ordensAbertas.forEach(o => mapTipo.set(o['ID'], norm(o['Tipo de manutenção'])));
        
        STATE.data.mo.forEach(m => {
            let realOrdId = null;
            if(m['ID_SERV']) { const s = servMap.get(m['ID_SERV']); if(s) realOrdId = s['ID_Ordem']; } else { realOrdId = m['ID_Ordem']; }
            if(realOrdId && idsAbertos.has(realOrdId)) {
                const h = calcDuration(m['Hora inicial'], m['Hora final']);
                if (h > 0) { totalHH += h; const t = mapTipo.get(realOrdId) || ''; if(t.includes('CORRETIVA')) hhCorr += h; else hhPrev += h; }
            }
        });

        document.getElementById('op-parados').innerText=frotaParada; document.getElementById('op-tma').innerText=tma+'d';
        document.getElementById('op-ordens').innerText=ordensAbertas.length; document.getElementById('op-hh').innerText=totalHH.toFixed(1)+'h';

        const tbodyOp=document.querySelector('#tableOp tbody'); tbodyOp.innerHTML='';
        ordensAbertas.forEach(o => {
            let oHH=0; 
            STATE.data.mo.forEach(m => {
                let realOrdId = null;
                if(m['ID_SERV']) { const s = servMap.get(m['ID_SERV']); if(s) realOrdId = s['ID_Ordem']; } else { realOrdId = m['ID_Ordem']; }
                if(realOrdId === o['ID']) oHH += calcDuration(m['Hora inicial'], m['Hora final']);
            });
            tbodyOp.innerHTML += `<tr><td style="color:var(--brand);font-weight:bold">${o['Nº Ordem']||'-'}</td><td><strong>${o['Frota']}</strong></td><td><span class="badge ${norm(o['Tipo de manutenção']).includes('CORRETIVA')?'bg-corr':'bg-prev'}">${o['Tipo de manutenção']}</span></td><td>${o['Modo de manutenção'].substring(0,4)}</td><td>${o['Data da abertura']}</td><td style="font-weight:bold">${oHH.toFixed(1)}h</td></tr>`;
        });
        renderDoughnutWithLabels('chartOpType', ['Corretiva', 'Preventiva'], [hhCorr, hhPrev], ['#e74c3c', '#3498db']);
    }

    // =========================================================================
    // LÓGICA GERENCIAL
    // =========================================================================
    function processManagerial() {
        const frota = STATE.data.frota.filter(f => {
            const t = norm(f['TIPO']), l = f['LOTE'];
            const isValid = !t.includes('APOIO') && !t.includes('EQUIPAMENTO') && l !== 'Desmobilizado';
            const isSelected = STATE.filters.contracts.has('Todos') || STATE.filters.contracts.has(l);
            return isValid && isSelected;
        });
        const idsF = new Set(frota.map(f => f['FROTA']));
        
        const ordemMap = new Map(); STATE.data.ordem.forEach(o => ordemMap.set(o['ID'], o));
        const servsCorretivos = STATE.data.serv.filter(s => {
            const ordem = ordemMap.get(s['ID_Ordem']);
            if(!ordem) return false;
            return idsF.has(s['Frota']) && norm(ordem['Status da ordem']) === 'ENCERRADA' && norm(ordem['Tipo de manutenção']).includes('CORRETIVA');
        });
        STATE.processed.centralData = servsCorretivos.map(s => {
            const ordem = ordemMap.get(s['ID_Ordem']);
            const dt = parseDate(ordem['Data da abertura']);
            return { data: dt, year: dt ? dt.getFullYear() : 0, month: dt ? dt.getMonth() : 0, natureza: s['Natureza do serviço'] || 'Outros', tipo: s['Tipo de serviço'] || s['Serviço'] || 'N/A' };
        });
        setupCentralFilters(); updateCentralCharts();

        const reqsEnc = STATE.data.req.filter(r => idsF.has(r['Frota']) && norm(r['Status da requisição']) === 'ENCERRADA');
        processMKBFData(reqsEnc); setupMKBFYearFilter(); renderMKBFPanels();
        processMTTRData(idsF); setupMTTRYearFilter(); renderMTTRPanels();

        const mkbfGlobal = calculateGlobalMKBF(reqsEnc);
        
        let totalH_KPI = 0;
        const idsCorrIds = new Set(STATE.data.ordem.filter(o => norm(o['Status da ordem'])==='ENCERRADA' && norm(o['Tipo de manutenção']).includes('CORRETIVA') && idsF.has(o['Frota'])).map(o=>o['ID']));
        STATE.data.mo.forEach(m=>{
            let realOrdId = null;
            if(m['ID_SERV']) { const s = STATE.data.serv.find(s => s['ID'] === m['ID_SERV']); if(s) realOrdId = s['ID_Ordem']; } else { realOrdId = m['ID_Ordem']; }
            if(realOrdId && idsCorrIds.has(realOrdId)) totalH_KPI += calcDuration(m['Hora inicial'], m['Hora final']);
        });
        const qtdOrdensCorr = idsCorrIds.size;
        const mttrKPI = qtdOrdensCorr > 0 ? (totalH_KPI / qtdOrdensCorr).toFixed(1) : 0;

        document.getElementById('mgmt-ativos').innerText = idsF.size;
        const reqOpen = STATE.data.req.filter(r => idsF.has(r['Frota']) && norm(r['Status da requisição'])!=='ENCERRADA' && norm(r['Status da requisição'])!=='CANCELADA');
        const parados = new Set(reqOpen.map(r=>r['Frota'])).size;
        const disp = idsF.size>0?((idsF.size-parados)/idsF.size*100).toFixed(1):0;
        document.getElementById('mgmt-disp').innerText = disp + '%';
        document.getElementById('mgmt-mkbf').innerText = Math.round(mkbfGlobal);
        document.getElementById('mgmt-mttr-kpi').innerText = mttrKPI + 'h';
    }

    // =========================================================================
    // LÓGICA PERFORMANCE TÉCNICA (ATUALIZADA COM FILTROS DE CARD E LIMPEZA)
    // =========================================================================
    function initTechnicalView() {
        const ordemMap = new Map(); STATE.data.ordem.forEach(o => ordemMap.set(o['ID'], o));
        const allDates = [];
        STATE.data.mo.forEach(m => {
            let o = null;
            if(m['ID_SERV']) { const s = STATE.data.serv.find(s => s['ID'] === m['ID_SERV']); if(s) o = ordemMap.get(s['ID_Ordem']); }
            else { o = ordemMap.get(m['ID_Ordem']); }
            if(o) { const d = parseDate(o['Data da abertura']); if(d) allDates.push(d); }
        });
        
        const uniqueYears = [...new Set(allDates.map(d => d.getFullYear()))].sort().reverse();
        const selY = document.getElementById('tech-year');
        const selM = document.getElementById('tech-month');
        
        if(selY.options.length === 0) {
            uniqueYears.forEach(y => addOption(selY, y, y));
            ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'].forEach((m, i) => addOption(selM, i, m));
            const now = new Date();
            if(uniqueYears.includes(now.getFullYear())) selY.value = now.getFullYear();
            selM.value = now.getMonth();
        }
        processTechnical();
    }

    function resetTechnicalView() {
        STATE.filters.selectedTech = null;
        const now = new Date();
        document.getElementById('tech-year').value = now.getFullYear();
        document.getElementById('tech-month').value = now.getMonth();
        processTechnical();
    }

    function processTechnical() {
        const year = parseInt(document.getElementById('tech-year').value);
        const month = parseInt(document.getElementById('tech-month').value);
        
        // Mapear contratos
        const frotaLoteMap = new Map(); STATE.data.frota.forEach(f => frotaLoteMap.set(f['FROTA'], f['LOTE']));
        const checkContract = (frota) => {
            if(STATE.filters.contracts.has('Todos')) return true;
            const lote = frotaLoteMap.get(frota); return lote && STATE.filters.contracts.has(lote);
        };

        // Mapear Função (tabela opcional)
        const techFuncMap = new Map();
        if(STATE.data.tec) {
            STATE.data.tec.forEach(t => techFuncMap.set(norm(t['Nome']||t['Técnico']), t['Função'] || '-'));
        }

        const techStats = {};
        const ordemMap = new Map(); STATE.data.ordem.forEach(o => ordemMap.set(o['ID'], o));
        const servMap = new Map(); STATE.data.serv.forEach(s => servMap.set(s['ID'], s));

        STATE.data.mo.forEach(m => {
            const techName = (m['Técnico'] || 'ND').trim().toUpperCase();
            if(techName === 'ND' || techName === '') return;

            let ordem = null;
            if(m['ID_SERV']) { const s = servMap.get(m['ID_SERV']); if(s) ordem = ordemMap.get(s['ID_Ordem']); }
            else { ordem = ordemMap.get(m['ID_Ordem']); }

            if(ordem) {
                const dtRef = parseDate(ordem['Data do fechamento'] || ordem['Data da abertura']);
                if(dtRef && dtRef.getFullYear() === year && dtRef.getMonth() === month) {
                    if(checkContract(ordem['Frota'])) {
                        if(!techStats[techName]) techStats[techName] = { hh: 0, orders: new Set(), days: new Set() };
                        const duration = calcDuration(m['Hora inicial'], m['Hora final']);
                        if(duration > 0) {
                            techStats[techName].hh += duration;
                            techStats[techName].orders.add(ordem['ID']);
                            techStats[techName].days.add(dtRef.toDateString()); 
                        }
                    }
                }
            }
        });

        let totalHH = 0;
        let totalOrdersSet = new Set();
        const ranking = [];

        Object.entries(techStats).forEach(([name, stat]) => {
            const funcao = techFuncMap.get(name) || '-';

            // Filtragem de KPI pelo técnico selecionado no gráfico (IMPORTANTE)
            if (STATE.filters.selectedTech === null || STATE.filters.selectedTech === name) {
                totalHH += stat.hh;
                stat.orders.forEach(o => totalOrdersSet.add(o));
            }

            const possibleHours = (stat.days.size * 8) || 1; 
            let occup = (stat.hh / possibleHours) * 100;
            if(occup > 100) occup = 100;

            ranking.push({
                name: name,
                funcao: funcao,
                hh: stat.hh,
                qtd: stat.orders.size,
                avg: stat.orders.size > 0 ? (stat.hh / stat.orders.size) : 0,
                occup: occup
            });
        });

        ranking.sort((a,b) => b.hh - a.hh);

        // Update KPIs (Os cartões agora refletem a seleção)
        const lblFilter = STATE.filters.selectedTech ? STATE.filters.selectedTech : (STATE.filters.contracts.has('Todos') ? 'Equipe Global' : 'Equipe Filtrada');
        document.getElementById('lbl-kpi-filter').innerText = lblFilter;
        document.getElementById('tech-total-hh').innerText = totalHH.toFixed(1) + 'h';
        document.getElementById('tech-total-ordens').innerText = totalOrdersSet.size;
        document.getElementById('tech-avg-prod').innerText = totalOrdersSet.size > 0 ? (totalHH / totalOrdersSet.size).toFixed(1) : '0';
        
        // Se houver seleção, contagem é 1, senão é total visível
        document.getElementById('tech-count').innerText = STATE.filters.selectedTech ? 1 : ranking.length;

        // Render Table
        const tbody = document.querySelector('#tableTechRanking tbody');
        tbody.innerHTML = '';
        ranking.forEach((r, i) => {
            const isSel = r.name === STATE.filters.selectedTech ? 'selected-row' : '';
            const row = `<tr class="clickable-row ${isSel}" onclick="selectTech('${r.name}')">
                <td>${i+1}º</td>
                <td style="font-weight:bold; color:var(--brand)">${r.name}</td>
                <td style="font-size:11px; color:#aaa">${r.funcao}</td>
                <td>${r.qtd}</td>
                <td>${r.hh.toFixed(1)}h</td>
                <td>${r.avg.toFixed(1)}h</td>
                <td><div style="background:#333; width:60px; height:6px; border-radius:3px; display:inline-block; margin-right:5px">
                    <div style="width:${r.occup}%; background:${r.occup>80?'#2ecc71':(r.occup>50?'#f1c40f':'#e74c3c')}; height:100%; border-radius:3px"></div>
                    </div> ${Math.round(r.occup)}%
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        renderTechScatter(ranking);
        
        // Evolução: Se tem selecionado, mostra ele. Senão, mostra média da equipe.
        // Passamos checkContract para garantir que a "Equipe" respeite o filtro de contrato
        updateTechEvolution(STATE.filters.selectedTech, checkContract);
    }

    function selectTech(name) {
        if (STATE.filters.selectedTech === name) STATE.filters.selectedTech = null; // Toggle off if clicked same
        else STATE.filters.selectedTech = name;
        processTechnical();
    }

    function renderTechScatter(data) {
        const ctx = document.getElementById('chartTechScatter').getContext('2d');
        if(charts['techScatter']) charts['techScatter'].destroy();
        
        const points = data.map(d => ({ 
            x: d.qtd, 
            y: d.hh, 
            name: d.name,
            color: (STATE.filters.selectedTech && STATE.filters.selectedTech !== d.name) ? '#444' : '#FFD700' 
        }));
        
        charts['techScatter'] = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Técnicos',
                    data: points,
                    backgroundColor: points.map(p => p.color),
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: function(ctx) { return ctx.raw.name + ': ' + ctx.raw.y.toFixed(1) + 'h (' + ctx.raw.x + ' OS)'; } }
                    },
                    datalabels: { display: false }
                },
                scales: {
                    x: { title: { display: true, text: 'Volume (Ordens)', color:'#666' }, grid: { color:'#333' }, ticks: { color:'#aaa' } },
                    y: { title: { display: true, text: 'Esforço (HH)', color:'#666' }, grid: { color:'#333' }, ticks: { color:'#aaa' } }
                },
                onClick: (e, el) => {
                    // Se clicou em um ponto
                    if(el.length > 0) {
                        const idx = el[0].index;
                        selectTech(points[idx].name);
                    } else {
                        // Clicou no fundo (limpar seleção) -> Implementação solicitada
                        if(STATE.filters.selectedTech) {
                            selectTech(null); 
                        }
                    }
                }
            }
        });
    }

    function updateTechEvolution(techName, checkContractFunc) {
        const title = techName ? `Evolução: ${techName}` : 'Evolução da Equipe';
        document.getElementById('tech-evol-name').innerText = title;
        
        const monthsData = [];
        const labels = [];
        const now = new Date();
        
        for(let i=5; i>=0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(d.toLocaleString('default', { month: 'short' }));
            monthsData.push(calcTechHHForMonth(techName, d.getFullYear(), d.getMonth(), checkContractFunc));
        }

        const ctx = document.getElementById('chartTechEvol').getContext('2d');
        if(charts['techEvol']) charts['techEvol'].destroy();
        
        charts['techEvol'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'HH Total',
                    data: monthsData,
                    borderColor: techName ? '#2ecc71' : '#3498db',
                    backgroundColor: techName ? 'rgba(46, 204, 113, 0.1)' : 'rgba(52, 152, 219, 0.1)',
                    fill: true, tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { grid: { display: false }, ticks: { color: '#aaa' } } }
            }
        });
    }

    function calcTechHHForMonth(targetName, year, month, checkContractFunc) {
        let hh = 0;
        const ordemMap = new Map(); STATE.data.ordem.forEach(o => ordemMap.set(o['ID'], o));
        const servMap = new Map(); STATE.data.serv.forEach(s => servMap.set(s['ID'], s));
        
        // Se targetName é null, soma todo mundo que passa no filtro
        STATE.data.mo.forEach(m => {
            const tName = (m['Técnico']||'').trim().toUpperCase();
            if(tName === '' || tName === 'ND') return;
            
            // Se tiver alvo, filtra. Se não tiver, soma todos da equipe.
            if(targetName && tName !== targetName) return;
            
            let ordem = null;
            if(m['ID_SERV']) { const s = servMap.get(m['ID_SERV']); if(s) ordem = ordemMap.get(s['ID_Ordem']); }
            else { ordem = ordemMap.get(m['ID_Ordem']); }
            
            if(ordem) {
                // Verificar filtro de contrato para a equipe se necessário
                if(!targetName && checkContractFunc && !checkContractFunc(ordem['Frota'])) return;

                const dt = parseDate(ordem['Data do fechamento'] || ordem['Data da abertura']);
                if(dt && dt.getFullYear() === year && dt.getMonth() === month) {
                    hh += calcDuration(m['Hora inicial'], m['Hora final']);
                }
            }
        });
        return hh;
    }

    // Auxiliares
    function parseDate(s) { if(!s)return null; if(s.includes('/')) {const p=s.split(' ')[0].split('/'); return new Date(p[2],p[1]-1,p[0]);} return new Date(s); }
    function calcDuration(s,e) { if(!s||!e)return 0; const tm=x=>{const p=x.split(':'); return parseInt(p[0])*60+parseInt(p[1])}; let d=tm(e)-tm(s); if(d<0)d+=1440; return d/60; }
    function calculateGlobalMKBF(r) {
        const g = {}; r.forEach(x => { if(!g[x['Frota']])g[x['Frota']]=[]; g[x['Frota']].push(parseInt(x['Odômetro (Km)'])||0); });
        let km=0, f=0; Object.values(g).forEach(k => { k.sort((a,b)=>a-b); for(let i=1; i<k.length; i++) { const d=k[i]-k[i-1]; if(d>0&&d<50000){km+=d; f++;} } });
        return f>0 ? km/f : 0;
    }
    // Funciona como setup e update
    function setupCentralFilters() { /* Já implementado acima, mantido estrutura */ }
</script>
</body>
</html>
