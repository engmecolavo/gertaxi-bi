<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI | Sistema de Gestão Gertáxi</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* --- TEMA DARK INDUSTRIAL (Premium) --- */
        :root {
            --bg-body: #121212; --bg-panel: #1e1e1e; --bg-header: #000000;
            --brand: #FFD700; --text-main: #E0E0E0; --text-muted: #A0A0A0; --border: #333;
            --green: #2ecc71; --red: #e74c3c; --blue: #3498db; --orange: #e67e22; --purple: #9b59b6;
        }
        * { box-sizing: border-box; outline: none; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }

        /* HEADER */
        header { background: var(--bg-header); border-bottom: 2px solid var(--brand); height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 100; position: relative; }
        .logo-area { display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 800; color: var(--text-main); letter-spacing: 1px; }
        
        /* NAV PILLS */
        .nav-pills { display: flex; gap: 5px; background: #222; padding: 4px; border-radius: 6px; }
        .nav-item { padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 13px; font-weight: 600; color: #888; transition: 0.2s; display: flex; align-items: center; gap: 5px; border: 1px solid transparent; }
        .nav-item.active { background: var(--brand); color: #000; }
        .nav-item:hover:not(.active) { color: var(--brand); border-color: #444; }

        /* FILTROS HEADER */
        .filter-bar { display: flex; align-items: center; gap: 10px; }
        select { background: #333; border: 1px solid #555; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 500; min-width: 150px; }
        select:hover { border-color: var(--brand); }

        /* DASHBOARD VIEW */
        .dashboard-view { display: none; padding: 20px; animation: fadein 0.4s; }
        .dashboard-view.visible { display: block; }
        @keyframes fadein { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* DATA DE HOJE (Operacional) */
        .date-display { font-size: 14px; color: var(--brand); font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; background: rgba(255, 215, 0, 0.05); padding: 8px 12px; border-radius: 4px; border-left: 3px solid var(--brand); width: fit-content; }

        /* KPI CARDS */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--bg-panel); padding: 15px; border-radius: 6px; border-left: 4px solid var(--brand); box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .card-value { font-size: 26px; font-weight: 700; margin-top: 5px; }
        .card-sub { font-size: 11px; opacity: 0.7; margin-top: 2px; }

        /* GRÁFICOS E TABELAS */
        .charts-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; } /* Ocupa linha inteira */
        
        .chart-panel { background: var(--bg-panel); border-radius: 6px; padding: 15px; display: flex; flex-direction: column; position: relative; min-height: 380px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: 600; color: var(--brand); font-size: 14px; }
        
        .table-container { height: 100%; overflow-y: auto; max-height: 320px; }
        
        /* TABELAS */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #252525; color: #aaa; padding: 10px 8px; position: sticky; top: 0; z-index: 2; border-bottom: 2px solid #444; }
        td { border-bottom: 1px solid #333; padding: 10px 8px; vertical-align: middle; }
        tr:hover { background: #2a2a2a; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; display: inline-block;}
        .bg-corr { background: rgba(231, 76, 60, 0.15); color: var(--red); border: 1px solid rgba(231, 76, 60, 0.3); }
        .bg-prev { background: rgba(52, 152, 219, 0.15); color: var(--blue); border: 1px solid rgba(52, 152, 219, 0.3); }
        .bg-start { background: rgba(46, 204, 113, 0.15); color: var(--green); border: 1px solid rgba(46, 204, 113, 0.3); animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        
        /* Filtro interno do gráfico */
        .chart-filter { padding: 2px 5px; font-size: 12px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; }

        @media (max-width: 1000px) { .charts-row { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <span class="material-icons" style="color:var(--brand); font-size: 32px;">directions_bus</span>
        <span>GERTÁXI BI</span>
    </div>
    
    <div class="nav-pills">
        <div class="nav-item active" onclick="setMode('operacional')">
            <span class="material-icons">build</span> PAINEL OPERACIONAL
        </div>
        <div class="nav-item" onclick="setMode('gerencial')">
            <span class="material-icons">insights</span> PAINEL GERENCIAL
        </div>
    </div>

    <div class="filter-bar">
        <select id="main-filter" onchange="runDashboardLogic()"></select>
        <div id="loading" style="font-size:12px; color:#666;">
            <span class="material-icons" style="font-size:12px; animation:spin 1s infinite linear">sync</span>
        </div>
    </div>
</header>

<div id="view-operacional" class="dashboard-view visible">
    
    <div class="date-display">
        <span class="material-icons" style="font-size:16px">calendar_today</span>
        <span id="display-date">--/--/----</span>
    </div>

    <div class="kpi-row">
        <div class="card" style="border-color: var(--red)">
            <div class="card-label">Veículos Parados</div>
            <div class="card-value" id="op-parados">0</div>
            <div class="card-sub">Oficina Atual (Req. Abertas)</div>
        </div>
        <div class="card" style="border-color: var(--orange)">
            <div class="card-label">Tempo Médio Parado</div>
            <div class="card-value" id="op-tma">0d</div>
            <div class="card-sub">Dias corridos (Abertas)</div>
        </div>
        <div class="card" style="border-color: var(--blue)">
            <div class="card-label">Ordens Abertas</div>
            <div class="card-value" id="op-ordens">0</div>
            <div class="card-sub">Fila de Trabalho</div>
        </div>
        <div class="card" style="border-color: var(--brand)">
            <div class="card-label">HH Total Previsto/Real</div>
            <div class="card-value" id="op-hh">0h</div>
            <div class="card-sub">Em aberto</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-panel">
            <div class="panel-header">Distribuição de HH (Abertas)</div>
            <div style="flex:1; position: relative;"><canvas id="chartOpType"></canvas></div>
        </div>
        <div class="chart-panel">
            <div class="panel-header">Fila de Ordens</div>
            <div class="table-container">
                <table id="tableOp">
                    <thead>
                        <tr>
                            <th>Nº Ordem</th>
                            <th>Frota</th>
                            <th>Tipo</th>
                            <th>Modo</th>
                            <th>Abertura</th>
                            <th>HH Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="chart-panel full-width">
            <div class="panel-header">
                <span><span class="material-icons" style="font-size:16px; vertical-align:bottom; color:var(--green)">engineering</span> Técnicos em Atividade (Apropriação Aberta Hoje)</span>
            </div>
            <div class="table-container">
                <table id="tableMO">
                    <thead>
                        <tr>
                            <th>Nº Ordem</th>
                            <th>Técnico</th>
                            <th>Frota</th>
                            <th>Tipo Manutenção</th>
                            <th>Natureza</th> <th>Serviço</th>
                            <th>Início</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="view-gerencial" class="dashboard-view">
    <div class="kpi-row">
        <div class="card">
            <div class="card-label">Ativos Produtivos</div>
            <div class="card-value" id="mgmt-ativos">0</div>
        </div>
        <div class="card" style="border-color: var(--green)">
            <div class="card-label">Disponibilidade Física</div>
            <div class="card-value" id="mgmt-disp">0%</div>
            <div class="card-sub">Estimada Atual</div>
        </div>
        <div class="card" style="border-color: var(--orange)">
            <div class="card-label">Tempo Médio (Histórico)</div>
            <div class="card-value" id="mgmt-tma">0d</div>
            <div class="card-sub">Ordens Encerradas</div>
        </div>
        <div class="card" style="border-color: var(--brand)">
            <div class="card-label">MKBF (Km/Falha)</div>
            <div class="card-value" id="mgmt-mkbf">0</div>
            <div class="card-sub">Média Global</div>
        </div>
        <div class="card" style="border-color: var(--red)">
            <div class="card-label">HH Total Corretivas</div>
            <div class="card-value" id="mgmt-hh">0h</div>
            <div class="card-sub">Histórico Encerrado</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-panel">
            <div class="panel-header">Serviços por Natureza (Clique para Filtrar)</div>
            <div style="flex:1; position: relative;"><canvas id="chartMgmtNatureza"></canvas></div>
        </div>
        <div class="chart-panel">
            <div class="panel-header">Pareto: Tipos de Falha <span id="pareto-filter-label" style="font-size:10px; color:#666; margin-left:10px">(Todas)</span></div>
            <div style="flex:1; position: relative;"><canvas id="chartMgmtPareto"></canvas></div>
        </div>

        <div class="chart-panel full-width">
            <div class="panel-header">
                <span>Evolução do MKBF (Km Médio entre Falhas)</span>
                <select id="mkbf-year" class="chart-filter" onchange="updateMKBFChart()">
                    </select>
            </div>
            <div style="flex:1; position: relative;"><canvas id="chartMgmtMKBF"></canvas></div>
        </div>
    </div>
</div>

<script>
    // --- LINKS CSV ---
    const FILES = {
        frota: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=752179198&single=true&output=csv',
        ordem: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=676143752&single=true&output=csv',
        req:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=1880712397&single=true&output=csv',
        serv:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=670071232&single=true&output=csv',
        mo:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_HABCKNyvRwnidGn1Wf5qFAx8AqXWQBszLO49Sm5fp7_5kYWnoQi3kDbSh-LyO0I9DoFHz7LRO8eU/pub?gid=267479044&single=true&output=csv'
    };

    const STATE = { mode: 'operacional', data: {}, filters: { contract: 'Todos', naturezaFocus: null } };
    let charts = {};

    window.onload = async () => { 
        await loadFiles(); 
        updateFilterOptions(); 
        
        // Exibir Data de Hoje
        const hoje = new Date();
        const opcoes = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('display-date').innerText = "Visão Operacional: " + hoje.toLocaleDateString('pt-BR', opcoes).toUpperCase();

        runDashboardLogic(); 
    };

    async function loadFiles() {
        try {
            if(FILES.frota.includes('COLE_AQUI')) { alert("Links CSV não configurados!"); return; }
            const promises = Object.entries(FILES).map(([key, url]) => fetch(url).then(r => r.text()).then(txt => ({key, txt})));
            const results = await Promise.all(promises);
            results.forEach(({key, txt}) => {
                const sep = txt.split('\n')[0].includes(';') ? ';' : ',';
                // trim() no header e dados
                STATE.data[key] = Papa.parse(txt, { header: true, delimiter: sep, skipEmptyLines: true, transformHeader: h=>h.trim() }).data;
            });
            document.getElementById('loading').innerText = 'Online';
        } catch (e) { console.error(e); alert("Erro ao carregar dados."); }
    }

    // --- UI ---
    function setMode(mode) {
        STATE.mode = mode;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="setMode('${mode}')"]`).classList.add('active');
        document.querySelectorAll('.dashboard-view').forEach(el => el.classList.remove('visible'));
        document.getElementById(`view-${mode}`).classList.add('visible');
        updateFilterOptions(); runDashboardLogic();
    }
    const norm = (str) => (str || '').toString().trim().toUpperCase();

    function updateFilterOptions() {
        const select = document.getElementById('main-filter'); select.innerHTML = '';
        if (!STATE.data.frota) return;
        const lotes = [...new Set(STATE.data.frota.map(f => f['LOTE']).filter(l => l && l.trim() !== '' && l !== 'Desmobilizado'))].sort();
        addOption(select, 'Todos', 'Todos os Contratos'); lotes.forEach(l => addOption(select, l, l));
    }
    function addOption(s,v,t) { const o=document.createElement('option'); o.value=v; o.innerText=t; s.appendChild(o); }
    function runDashboardLogic() { const f = document.getElementById('main-filter').value; STATE.mode === 'operacional' ? processOperational(f) : processManagerial(f); }

    // =========================================================================
    // OPERACIONAL
    // =========================================================================
    function processOperational(contractFilter) {
        const frotaLoteMap = new Map();
        STATE.data.frota.forEach(f => frotaLoteMap.set(f['FROTA'], f['LOTE']));

        // Filtro Contrato
        const checkContract = (frota) => {
            if (contractFilter === 'Todos') return true;
            return frotaLoteMap.get(frota) === contractFilter;
        };

        // 1. KPIs
        const reqsAbertas = STATE.data.req.filter(r => {
            const st = norm(r['Status da requisição']);
            return (st !== 'ENCERRADA' && st !== 'CANCELADA') && checkContract(r['Frota']);
        });
        const frotaParada = new Set(reqsAbertas.map(r => r['Frota'])).size;

        const ordensAbertas = STATE.data.ordem.filter(o => {
            return norm(o['Status da ordem']) === 'ABERTA' && checkContract(o['Frota']);
        });

        // 2. Tabela MO (NOVA LÓGICA: Hora Final em Branco)
        // Varre a tabela MO procurando quem está trabalhando AGORA (sem hora final)
        const moAtiva = STATE.data.mo.filter(m => {
            const horaFinal = (m['Hora final'] || '').trim();
            return horaFinal === ''; // Se vazio, está em atividade
        });

        const moTabelaDados = [];

        moAtiva.forEach(m => {
            // ID de vínculo pode ser ID_SERV ou ID_Ordem
            const idVinculo = m['ID_SERV'] || m['ID_Ordem'];
            
            // Busca o Serviço correspondente (para pegar Natureza e Tipo)
            // Se ID_SERV aponta para Ordem, temos que buscar serviços daquela ordem.
            // Mas geralmente ID_SERV aponta para a linha de serviço.
            let servico = STATE.data.serv.find(s => s['ID'] === idVinculo);
            
            // Se não achou por ID direto, tenta achar se o vínculo é ID_Ordem (pode ser impreciso se tiver varios serviços, mas é fallback)
            if (!servico) {
                // Tenta achar algum serviço dessa ordem
                servico = STATE.data.serv.find(s => s['ID_Ordem'] === idVinculo);
            }

            if (servico) {
                // Checa contrato da frota do serviço
                if (checkContract(servico['Frota'])) {
                    // Busca Ordem para pegar Nº e Tipo Manut
                    const ordem = STATE.data.ordem.find(o => o['ID'] === servico['ID_Ordem']);
                    
                    moTabelaDados.push({
                        numOrdem: ordem ? ordem['Nº Ordem'] : '?',
                        tecnico: m['Técnico'] || 'Não ident.',
                        frota: servico['Frota'],
                        tipoManut: ordem ? ordem['Tipo de manutenção'] : 'N/A',
                        natureza: servico['Natureza do serviço'] || 'Geral', // NOVA COLUNA
                        tipoServ: servico['Tipo de serviço'] || servico['Serviço'],
                        inicio: m['Hora inicial'] || '--:--',
                        status: 'EM ANDAMENTO'
                    });
                }
            }
        });

        // Renderiza Tabela MO
        const tbodyMO = document.querySelector('#tableMO tbody'); tbodyMO.innerHTML = '';
        if(moTabelaDados.length === 0) {
            tbodyMO.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#666; padding:20px">Nenhum técnico em atividade (apontamento aberto) no momento.</td></tr>';
        } else {
            moTabelaDados.forEach(d => {
                const row = `<tr>
                    <td style="font-weight:bold; color:var(--brand)">${d.numOrdem}</td>
                    <td style="font-weight:bold; color:#fff">${d.tecnico}</td>
                    <td style="color:#aaa">${d.frota}</td>
                    <td><span class="badge ${norm(d.tipoManut).includes('CORRETIVA') ? 'bg-corr' : 'bg-prev'}">${d.tipoManut}</span></td>
                    <td style="color:#ddd">${d.natureza}</td>
                    <td>${d.tipoServ}</td>
                    <td>${d.inicio}</td>
                    <td><span class="badge bg-start">EM ATIVIDADE</span></td>
                </tr>`;
                tbodyMO.innerHTML += row;
            });
        }

        // ... (Cálculos de KPIs Operacionais existentes mantidos) ...
        let somaDias = 0; const hoje = new Date();
        ordensAbertas.forEach(o => { const d = parseDate(o['Data da abertura']); if(d) somaDias += (hoje-d)/(864e5); });
        const tma = ordensAbertas.length > 0 ? (somaDias/ordensAbertas.length).toFixed(1) : 0;
        let totalHH = 0, hhCorr = 0, hhPrev = 0;
        const idsAbertos = new Set(ordensAbertas.map(o => o['ID']));
        const mapTipo = new Map(); ordensAbertas.forEach(o => mapTipo.set(o['ID'], norm(o['Tipo de manutenção'])));
        STATE.data.mo.forEach(m => {
            const ref = m['ID_SERV'] || m['ID_Ordem'];
            if(idsAbertos.has(ref)) {
                const h = calcDuration(m['Hora inicial'], m['Hora final']);
                totalHH += h;
                const t = mapTipo.get(ref) || '';
                t.includes('CORRETIVA') ? hhCorr += h : hhPrev += h;
            }
        });

        document.getElementById('op-parados').innerText = frotaParada;
        document.getElementById('op-tma').innerText = tma + 'd';
        document.getElementById('op-ordens').innerText = ordensAbertas.length;
        document.getElementById('op-hh').innerText = totalHH.toFixed(1) + 'h';

        const tbodyOp = document.querySelector('#tableOp tbody'); tbodyOp.innerHTML = '';
        ordensAbertas.forEach(o => {
            let oHH = 0;
            STATE.data.mo.forEach(m => { if((m['ID_SERV']||m['ID_Ordem']) === o['ID']) oHH += calcDuration(m['Hora inicial'], m['Hora final']); });
            const tp = norm(o['Tipo de manutenção']);
            const badge = tp.includes('CORRETIVA') ? 'bg-corr' : 'bg-prev';
            // Adicionado Nº Ordem na Fila de Ordens
            tbodyOp.innerHTML += `<tr>
                <td style="color:var(--brand);font-weight:bold">${o['Nº Ordem'] || '-'}</td>
                <td><strong>${o['Frota']}</strong></td>
                <td><span class="badge ${badge}">${o['Tipo de manutenção']}</span></td>
                <td>${o['Modo de manutenção']}</td>
                <td>${o['Data da abertura']}</td>
                <td style="font-weight:bold">${oHH.toFixed(1)}h</td>
            </tr>`;
        });
        renderDoughnut('chartOpType', ['Corretiva', 'Preventiva'], [hhCorr, hhPrev], ['#e74c3c', '#3498db']);
    }

    // =========================================================================
    // GERENCIAL
    // =========================================================================
    function processManagerial(contratoFilter) {
        const frota = STATE.data.frota.filter(f => {
            const t = norm(f['TIPO']), l = f['LOTE'];
            return !t.includes('APOIO') && !t.includes('EQUIPAMENTO') && l !== 'Desmobilizado' && (contratoFilter === 'Todos' || l === contratoFilter);
        });
        const idsF = new Set(frota.map(f => f['FROTA']));
        
        // KPIs existentes...
        const enc = STATE.data.ordem.filter(o => o['Status da ordem'] === 'ENCERRADA' && idsF.has(o['Frota']));
        const idsEnc = new Set(enc.map(o => o['ID']));
        const idsCorr = new Set(enc.filter(o => norm(o['Tipo de manutenção']).includes('CORRETIVA')).map(o => o['ID']));
        const servs = STATE.data.serv.filter(s => idsCorr.has(s['ID_Ordem']));
        const reqsEnc = STATE.data.req.filter(r => idsF.has(r['Frota']) && r['Status da requisição'] === 'ENCERRADA');
        
        // Cálculos...
        const mkbf = calculateGlobalMKBF(reqsEnc);
        let sDias = 0, cReq = 0;
        reqsEnc.forEach(r => { const i = parseDate(r['Data da parada']), f = parseDate(r['Data da liberação']); if(i&&f) { sDias += (f-i)/(864e5); cReq++; }});
        const tmaHist = cReq > 0 ? (sDias/cReq).toFixed(1) : 0;
        let hhC = 0;
        STATE.data.mo.forEach(m => { 
            const ref = m['ID_SERV'] || m['ID_Ordem'];
            if(idsCorr.has(ref)) hhC += calcDuration(m['Hora inicial'], m['Hora final']); 
        });
        const reqOpen = STATE.data.req.filter(r => idsF.has(r['Frota']) && norm(r['Status da requisição']) !== 'ENCERRADA' && norm(r['Status da requisição']) !== 'CANCELADA');
        const parados = new Set(reqOpen.map(r => r['Frota'])).size;
        const disp = idsF.size > 0 ? ((idsF.size - parados)/idsF.size * 100).toFixed(1) : 0;

        // Atualiza KPIs
        document.getElementById('mgmt-ativos').innerText = idsF.size;
        document.getElementById('mgmt-disp').innerText = disp + '%';
        document.getElementById('mgmt-tma').innerText = tmaHist + 'd';
        document.getElementById('mgmt-mkbf').innerText = Math.round(mkbf);
        document.getElementById('mgmt-hh').innerText = hhC.toFixed(0) + 'h';

        // Gráficos existentes
        const cNat = {}; servs.forEach(s => { const n = s['Natureza do serviço']||'Outros'; cNat[n] = (cNat[n]||0)+1; });
        renderInteractiveDoughnut(Object.keys(cNat), Object.values(cNat), servs);
        updatePareto(servs);

        // 3. NOVO GRÁFICO MKBF (Mensal)
        // Passamos as requisições filtradas por contrato para o módulo do gráfico
        setupMKBFChart(reqsEnc);
    }

    // =========================================================================
    // MÓDULO MKBF MENSAL (NOVO)
    // =========================================================================
    let mkbfRawData = [];

    function setupMKBFChart(reqs) {
        // 1. Processar dados para formato mensal
        // Agrupar por frota e ordenar datas
        const byFrota = {};
        reqs.forEach(r => {
            if(!byFrota[r['Frota']]) byFrota[r['Frota']] = [];
            byFrota[r['Frota']].push({
                date: parseDate(r['Data da parada']),
                km: parseInt(r['Odômetro (Km)']) || 0
            });
        });

        // Calcular deltas e atribuir ao mês
        // Estrutura: { '2025': { '0': {km: 500, falhas: 2}, '1': ... } }
        const yearsData = {};

        Object.values(byFrota).forEach(list => {
            list.sort((a,b) => a.km - b.km); // Ordena por Km (ou data)
            for(let i=1; i < list.length; i++) {
                const delta = list[i].km - list[i-1].km;
                const dt = list[i].date;
                if(dt && delta > 0 && delta < 50000) { // Delta válido
                    const y = dt.getFullYear();
                    const m = dt.getMonth(); // 0-11
                    
                    if(!yearsData[y]) yearsData[y] = {};
                    if(!yearsData[y][m]) yearsData[y][m] = { km:0, falhas:0 };
                    
                    yearsData[y][m].km += delta;
                    yearsData[y][m].falhas++;
                }
            }
        });

        mkbfRawData = yearsData;

        // 2. Popular Filtro de Ano
        const select = document.getElementById('mkbf-year');
        const availableYears = Object.keys(yearsData).sort().reverse();
        
        // Salva seleção atual ou pega o ano mais recente
        const currentVal = select.value;
        select.innerHTML = '';
        
        if (availableYears.length === 0) {
            addOption(select, '', 'Sem dados');
            updateMKBFChart();
            return;
        }

        availableYears.forEach(y => addOption(select, y, y));
        
        if (currentVal && availableYears.includes(currentVal)) select.value = currentVal;
        else select.value = availableYears[0];

        updateMKBFChart();
    }

    function updateMKBFChart() {
        const year = document.getElementById('mkbf-year').value;
        if(!year || !mkbfRawData[year]) {
            renderAreaChart([], []);
            return;
        }

        const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        const data = [];
        
        // Preenche os 12 meses
        for(let m=0; m<12; m++) {
            const entry = mkbfRawData[year][m];
            if(entry && entry.falhas > 0) {
                data.push(Math.round(entry.km / entry.falhas));
            } else {
                data.push(0); // Ou null para quebrar a linha
            }
        }

        renderAreaChart(meses, data);
    }

    function renderAreaChart(labels, data) {
        const ctx = document.getElementById('chartMgmtMKBF').getContext('2d');
        if(charts['mkbf']) charts['mkbf'].destroy();

        charts['mkbf'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'MKBF (Km)',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)', // Azul suave
                    borderColor: '#3498db',
                    tension: 0.4, // Curva suave
                    pointBackgroundColor: '#fff',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' } },
                    x: { grid: { display: false }, ticks: { color: '#aaa' } }
                },
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
            }
        });
    }


    // --- HELPERS GRÁFICOS GENÉRICOS ---
    function renderDoughnut(id, l, d, c) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, { type: 'doughnut', data: {labels:l, datasets:[{data:d, backgroundColor:c, borderWidth:0}]}, options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'#aaa'}}}} });
    }
    function renderInteractiveDoughnut(l, d, allS) {
        const ctx = document.getElementById('chartMgmtNatureza').getContext('2d');
        if(charts['natureza']) charts['natureza'].destroy();
        charts['natureza'] = new Chart(ctx, {
            type: 'doughnut', data: {labels:l, datasets:[{data:d, backgroundColor:['#e74c3c','#f1c40f','#3498db','#9b59b6','#2ecc71','#e67e22'], borderWidth:0}]},
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'#aaa'}}},
                onClick: (e, el) => {
                    if(el.length > 0) {
                        const lbl = l[el[0].index]; STATE.filters.naturezaFocus = lbl;
                        document.getElementById('pareto-filter-label').innerText = `(Filtro: ${lbl})`;
                        updatePareto(allS.filter(s => s['Natureza do serviço'] === lbl));
                    } else {
                        STATE.filters.naturezaFocus = null; document.getElementById('pareto-filter-label').innerText = `(Todas)`;
                        updatePareto(allS);
                    }
                }
            }
        });
    }
    function updatePareto(lst) {
        const c = {}; lst.forEach(s => { const t = s['Tipo de serviço']||s['Serviço']||'N/A'; c[t] = (c[t]||0)+1; });
        const srtd = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const l = srtd.map(x=>x[0]), v = srtd.map(x=>x[1]);
        let sum = 0, tot = v.reduce((a,b)=>a+b,0); const acc = v.map(val=>{sum+=val; return (sum/tot)*100;});
        const ctx = document.getElementById('chartMgmtPareto').getContext('2d');
        if(charts['pareto']) charts['pareto'].destroy();
        charts['pareto'] = new Chart(ctx, {
            type: 'bar', data: {labels:l, datasets:[{label:'Qtd', data:v, backgroundColor:'#FFD700', order:2}, {label:'Acumulado %', data:acc, type:'line', borderColor:'#e74c3c', yAxisID:'y1', order:1}]},
            options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, grid:{color:'#333'}}, y1:{position:'right', min:0, max:100, grid:{display:false}}, x:{ticks:{color:'#aaa', font:{size:10}}}} }
        });
    }

    // --- HELPERS CÁLCULO ---
    function parseDate(s) { if(!s)return null; if(s.includes('/')) {const p=s.split(' ')[0].split('/'); return new Date(p[2],p[1]-1,p[0]);} return new Date(s); }
    function calcDuration(s,e) { if(!s||!e)return 0; const tm=x=>{const p=x.split(':'); return parseInt(p[0])*60+parseInt(p[1])}; let d=tm(e)-tm(s); if(d<0)d+=1440; return d/60; }
    function calculateGlobalMKBF(r) {
        const g = {}; r.forEach(x => { if(!g[x['Frota']])g[x['Frota']]=[]; g[x['Frota']].push(parseInt(x['Odômetro (Km)'])||0); });
        let km=0, f=0; Object.values(g).forEach(k => { k.sort((a,b)=>a-b); for(let i=1; i<k.length; i++) { const d=k[i]-k[i-1]; if(d>0&&d<50000){km+=d; f++;} } });
        return f>0 ? km/f : 0;
    }
</script>
</body>
</html>
